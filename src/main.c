#include "process_directeur.h"

					// CE FICHIER CONTIENT L'IMPLEMENTATION DES CREATIONS DE PROCESSUS CHEFS D'EQUIPE/THREADS EMPLOYES //

int main(int argc, char** argv){
  
			/// Déclarations de toutes les variables ///

	float res = 0.0;
	int nb_fichiers = 0, i=0;
    char chemin[5] = "./";
	DIR* rep = NULL;
	struct dirent* fichier_lu = NULL;
	char code[3];
	void* fonction;
	int compteur = 0;
	
			/// Demande du nombre de fichiers et du code de fnction à l'utilisateur ///
	
	printf("Donner le nombre de fichiers se trouvant dans le répertoire 'bin' :\n");
	scanf("%d",&nb_fichiers);
	char** noms_fichiers = NULL;
	noms_fichiers = malloc(nb_fichiers*sizeof(char*));
	printf("Donner le code de la fonction à réaliser sur cet ensemble de fichiers :\n");
	scanf("%s", code);
	printf("\n");
	fonction = min;
	
	
			/// Ouverture du chemin pour aller récupérer les fichiers ///
	
	rep = opendir(chemin);
	if(rep == NULL) { //Vérification que le répertoire ait bien été ouvert
		printf("Le répertoire n'a pas été ouvert.\n");
		exit(1);
	}

			/// Stockage du nom des fichiers dans un tableau de chaine de caractères ///

	if(nb_fichiers == 0){
		printf("Il n'y a aucun fichier dans le répertoire sélectionné");
		exit(EXIT_FAILURE);
	}
	fichier_lu = readdir(rep);//lecture du premier nom du fichier
	if(fichier_lu == NULL){
		printf("Il n'y a aucun fichier dans le répertoire sélectionné");
		exit(EXIT_FAILURE);
	}
	compteur++;
	for(i = 1; fichier_lu != NULL ; i++){
		fichier_lu = readdir(rep); //lecture du nom du fichier
		compteur++;
	}
	if(compteur != nb_fichiers){
		printf("Il n'y a pas le bon nombre de fichiers présents dans le répertoire");
		exit(EXIT_FAILURE);
	}
	if(closedir(rep) == -1){
		printf("Il y a un problème avec la fermeture du fichier.");
		exit(EXIT_FAILURE);
	}
	
	/* Comme notre exécutable se trouve dans ce dossier on compare ce qui est lu
	* avec le nom de l'excutable pour ne pas le mettre dans les fichiers à ouvrir */
	if(strcmp(fichier_lu->d_name, "reduction") != 0); 
		noms_fichiers[i] = fichier_lu->d_name;

			/// Lancement du processus directeur ///
			
	res = processus_directeur(code, fonction, nb_fichiers, noms_fichiers);

			/// Affichage du résultat ///
			
	if(nb_fichiers == 1)
		printf("La fonction %s appliquée au fichier %s donne le resultat suivant : %f\n", code, noms_fichiers[0], res);
	else
		printf("La fonction %s appliquée à l'ensemble des %d fichiers donne le resultat suivant : %f\n", code, nb_fichiers, res);
	
	return 0;
}

