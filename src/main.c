#include "process_directeur.h"

					// CE FICHIER CONTIENT L'IMPLEMENTATION DES CREATIONS DE PROCESSUS CHEFS D'EQUIPE/THREADS EMPLOYES //

int main(int argc, char** argv){
  
			/// Déclarations de toutes les variables ///
	float res = 0.0;
	int nb_fichiers = 0, i=0;
	DIR* rep = NULL;
	struct dirent* fichier_lu = NULL;
	char code[3];
	void* fonction;
	
			/// Demande du nombre de fichiers et du code de fonction à l'utilisateur ///
	printf("Donner le nombre de fichiers se trouvant dans le répertoire 'bin' :\n");
	scanf("%d",&nb_fichiers);
	char** noms_fichiers = NULL;
	noms_fichiers = malloc(nb_fichiers*sizeof(sizeof(char)*15));
	printf("Donner le code de la fonction à réaliser sur cet ensemble de fichiers :\n");
	scanf("%s", code);
	printf("\n");
	fonction = recherche_code(code);
	
	
			/// Ouverture du chemin pour aller récupérer les fichiers ///
	rep = opendir("./");
	if(rep == NULL) { //Vérification que le répertoire ait bien été ouvert
		printf("Le répertoire n'a pas été ouvert.\n");
		exit(1);
	}

			/// Stockage du nom des fichiers dans un tableau de chaine de caractères ///
	if(nb_fichiers == 0){
		printf("Il n'y a aucun fichier dans le répertoire sélectionné");
		exit(EXIT_FAILURE);
	}
	
	for(i=0; i<nb_fichiers; i++){
		fichier_lu = readdir(rep); //lecture du nom du fichier
	
	/* Comme notre exécutable se trouve dans ce dossier on compare ce qui est lu
	* avec le nom de l'excutable pour ne pas le mettre dans les fichiers à ouvrir */
		if(strcmp(fichier_lu->d_name, "..") != 0){ 
			noms_fichiers[i] = fichier_lu->d_name;
		} else {
			i--;
		}
	}
	
	if(closedir(rep) == -1){
		printf("Il y a un problème avec la fermeture du fichier.");
		exit(EXIT_FAILURE);
	}
		
			/// Lancement du processus directeur ///
	res = processus_directeur(fonction, nb_fichiers, noms_fichiers);

			/// Affichage du résultat ///
	if(nb_fichiers == 1)
		printf("La fonction %s appliquée au fichier %s donne le resultat suivant : %f\n", code, noms_fichiers[0], res);
	else
		printf("La fonction %s appliquée à l'ensemble des %d fichiers donne le resultat suivant : %f\n", code, nb_fichiers, res);
	
	free(&noms_fichiers);
	return 0;
}

